<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>flask 源码解析：上下文 | Esoft Mobile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="上下文（application context 和 request context）上下文一直是计算机中难理解的概念，在知乎的一个问题下面有个很通俗易懂的回答：

每一段程序都有很多外部变量。只有像Add这种简单的函数才是没有外部变量的。一旦你的一段程序有了外部变量，这段程序就不完整，不能独立运行。你为了使他们运行，就要给所有的外部变量一个一个写一些值进去。这些值的集合就叫上下文。 – vzch">
<meta property="og:type" content="article">
<meta property="og:title" content="flask 源码解析：上下文">
<meta property="og:url" content="http://esoftmobile.com/2017/03/09/flask-context/index.html">
<meta property="og:site_name" content="Esoft Mobile">
<meta property="og:description" content="上下文（application context 和 request context）上下文一直是计算机中难理解的概念，在知乎的一个问题下面有个很通俗易懂的回答：

每一段程序都有很多外部变量。只有像Add这种简单的函数才是没有外部变量的。一旦你的一段程序有了外部变量，这段程序就不完整，不能独立运行。你为了使他们运行，就要给所有的外部变量一个一个写一些值进去。这些值的集合就叫上下文。 – vzch">
<meta property="og:image" content="http://esoftmobile.com/image/flask.png">
<meta property="og:updated_time" content="2017-03-10T06:57:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flask 源码解析：上下文">
<meta name="twitter:description" content="上下文（application context 和 request context）上下文一直是计算机中难理解的概念，在知乎的一个问题下面有个很通俗易懂的回答：

每一段程序都有很多外部变量。只有像Add这种简单的函数才是没有外部变量的。一旦你的一段程序有了外部变量，这段程序就不完整，不能独立运行。你为了使他们运行，就要给所有的外部变量一个一个写一些值进去。这些值的集合就叫上下文。 – vzch">
<meta name="twitter:image" content="http://esoftmobile.com/image/flask.png">
    

    
        <link rel="alternate" href="/atom.xml" title="Esoft Mobile" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Esoft Mobile</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">TracyYih</h2>
            <h3 id="title">Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Wuhan, China</span>
            <a id="follow" target="_blank" href="https://weibo.com/534072785">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                41
                <span>文章</span>
            </div>
            <div class="article-info-block">
                23
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/tracy-e" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/tracyyih" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://weibo.com/534072785" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-flask-context" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            flask 源码解析：上下文
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/03/09/flask-context/">
            <label>TracyYih 发表于 </label><time datetime="2017-03-09T08:50:31.000Z" itemprop="datePublished">2017-03-09 16:50</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/flask/">flask</a>, <a class="tag-link" href="/tags/python/">python</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="上下文（application-context-和-request-context）"><a href="#上下文（application-context-和-request-context）" class="headerlink" title="上下文（application context 和 request context）"></a>上下文（application context 和 request context）</h2><p>上下文一直是计算机中难理解的概念，在知乎的一个问题下面有个很通俗易懂的回答：</p>
<blockquote>
<p>每一段程序都有很多外部变量。只有像Add这种简单的函数才是没有外部变量的。一旦你的一段程序有了外部变量，这段程序就不完整，不能独立运行。你为了使他们运行，就要给所有的外部变量一个一个写一些值进去。这些值的集合就叫上下文。 – vzch</p>
</blockquote>
<p>比如，在 flask 中，视图函数需要知道它执行情况的请求信息（请求的 url，参数，方法等）以及应用信息（应用中初始化的数据库等），才能够正确运行。</p>
<p>最直观地做法是把这些信息封装成一个对象，作为参数传递给视图函数。但是这样的话，所有的视图函数都需要添加对应的参数，即使该函数内部并没有使用到它。</p>
<a id="more"></a>
<p>flask 的做法是把这些信息作为类似全局变量的东西，视图函数需要的时候，可以使用 <code>from flask import request</code> 获取。但是这些对象和全局变量不同的是——它们必须是动态的，因为在多线程或者多协程的情况下，每个线程或者协程获取的都是自己独特的对象，不会互相干扰。</p>
<p>那么如何实现这种效果呢？如果对 python 多线程比较熟悉的话，应该知道多线程中有个非常类似的概念 <code>threading.local</code>，可以实现多线程访问某个变量的时候只看到自己的数据。内部的原理说起来也很简单，这个对象有一个字典，保存了线程 id 对应的数据，读取该对象的时候，它动态地查询当前线程 id 对应的数据。flaskpython 上下文的实现也类似，后面会详细解释。</p>
<p>flask 中有两种上下文：<code>application context</code> 和 <code>request context</code>。上下文有关的内容定义在 <code>globals.py</code> 文件，文件的内容也非常短：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_req_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _request_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_request_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_app_object</span><span class="params">(name)</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, name)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_find_app</span><span class="params">()</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> top.app</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># context locals</span></div><div class="line">_request_ctx_stack = LocalStack()</div><div class="line">_app_ctx_stack = LocalStack()</div><div class="line">current_app = LocalProxy(_find_app)</div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div><div class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</div><div class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">'g'</span>))</div></pre></td></tr></table></figure>
<p>flask 提供两种上下文：<code>application context</code> 和 <code>request context</code> 。<code>app location context</code> 又演化出来两个变量 <code>current_app</code> 和 <code>g</code>，而 <code>request context</code> 则演化出来 <code>request</code> 和 <code>session</code>。</p>
<p>这里的实现用到了两个东西：<code>LocalStack</code> 和 <code>LocalProxy</code>。它们两个的结果就是我们可以动态地获取两个上下文的内容，在并发程序中每个视图函数都会看到属于自己的上下文，而不会出现混乱。</p>
<p><code>LocalStack</code> 和 <code>LocalProxy</code> 都是 <code>werkzeug</code> 提供的，定义在 <code>local.py</code> 文件中。在分析这两个类之前，我们先介绍这个文件另外一个基础的类 Local。Local 就是实现了类似 <code>threading.local</code> 的效果——多线程或者多协程情况下全局变量的隔离效果。下面是它的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># since each thread has its own greenlet we can just use those as identifiers</span></div><div class="line"><span class="comment"># for the context.  If greenlets are not available we fall back to the</span></div><div class="line"><span class="comment"># current thread ident depending on where it is.</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> greenlet <span class="keyword">import</span> getcurrent <span class="keyword">as</span> get_ident</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">from</span> thread <span class="keyword">import</span> get_ident</div><div class="line">    <span class="keyword">except</span> ImportError:</div><div class="line">        <span class="keyword">from</span> _thread <span class="keyword">import</span> get_ident</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Local</span><span class="params">(object)</span>:</span></div><div class="line">    __slots__ = (<span class="string">'__storage__'</span>, <span class="string">'__ident_func__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 数据保存在 __storage__ 中，后续访问都是对该属性的操作</span></div><div class="line">        object.__setattr__(self, <span class="string">'__storage__'</span>, &#123;&#125;)</div><div class="line">        object.__setattr__(self, <span class="string">'__ident_func__'</span>, get_ident)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, proxy)</span>:</span></div><div class="line">        <span class="string">"""Create a proxy for a name."""</span></div><div class="line">        <span class="keyword">return</span> LocalProxy(self, proxy)</div><div class="line"></div><div class="line">    <span class="comment"># 清空当前线程/协程保存的所有数据</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></div><div class="line">        self.__storage__.pop(self.__ident_func__(), <span class="keyword">None</span>)</div><div class="line"></div><div class="line">    <span class="comment"># 下面三个方法实现了属性的访问、设置和删除。</span></div><div class="line">    <span class="comment"># 注意到，内部都调用 `self.__ident_func__` 获取当前线程或者协程的 id，然后再访问对应的内部字典。</span></div><div class="line">    <span class="comment"># 如果访问或者删除的属性不存在，会抛出 AttributeError。</span></div><div class="line">    <span class="comment"># 这样，外部用户看到的就是它在访问实例的属性，完全不知道字典或者多线程/协程切换的实现</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self.__storage__[self.__ident_func__()][name]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></div><div class="line">        ident = self.__ident_func__()</div><div class="line">        storage = self.__storage__</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            storage[ident][name] = value</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            storage[ident] = &#123;name: value&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">del</span> self.__storage__[self.__ident_func__()][name]</div><div class="line">        <span class="keyword">except</span> KeyError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(name)</div></pre></td></tr></table></figure>
<p>可以看到，<code>Local</code> 对象内部的数据都是保存在 <code>__storage__</code> 属性的，这个属性变量是个嵌套的字典：<code>map[ident]map[key]value</code>。最外面字典 key 是线程或者协程的 identity，value 是另外一个字典，这个内部字典就是用户自定义的 key-value 键值对。用户访问实例的属性，就变成了访问内部的字典，外面字典的 key 是自动关联的。<code>__ident_func</code> 是 协程的 <code>get_current</code> 或者线程的 <code>get_ident</code>，从而获取当前代码所在线程或者协程的 id。</p>
<p>除了这些基本操作之外，<code>Local</code> 还实现了 <code>__release_local__</code> ，用来清空（析构）当前线程或者协程的数据（状态）。<code>__call__</code> 操作来创建一个 <code>LocalProxy</code> 对象，<code>LocalProxy</code> 会在下面讲到。</p>
<p>理解了 <code>Local</code>，我们继续回来看另外两个类。</p>
<p><code>LocalStack</code> 是基于 <code>Local</code> 实现的栈结构。如果说 <code>Local</code> 提供了多线程或者多协程隔离的属性访问，那么 <code>LocalStack</code> 就提供了隔离的栈访问。下面是它的实现代码，可以看到它提供了 <code>push</code>、<code>pop</code> 和 <code>top</code> 方法。</p>
<p><code>__release_local__</code> 可以用来清空当前线程或者协程的栈数据，<code>__call__</code> 方法返回当前线程或者协程栈顶元素的代理对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalStack</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""This class works similar to a :class:`Local` but keeps a stack</span></div><div class="line">    of objects instead. """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self._local = Local()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__release_local__</span><span class="params">(self)</span>:</span></div><div class="line">        self._local.__release_local__()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_lookup</span><span class="params">()</span>:</span></div><div class="line">            rv = self.top</div><div class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> RuntimeError(<span class="string">'object unbound'</span>)</div><div class="line">            <span class="keyword">return</span> rv</div><div class="line">        <span class="keyword">return</span> LocalProxy(_lookup)</div><div class="line"></div><div class="line">    <span class="comment"># push、pop 和 top 三个方法实现了栈的操作，</span></div><div class="line">    <span class="comment"># 可以看到栈的数据是保存在 self._local.stack 属性中的</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, obj)</span>:</span></div><div class="line">        <span class="string">"""Pushes a new item to the stack"""</span></div><div class="line">        rv = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            self._local.stack = rv = []</div><div class="line">        rv.append(obj)</div><div class="line">        <span class="keyword">return</span> rv</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Removes the topmost item from the stack, will return the</span></div><div class="line">        old value or `None` if the stack was already empty.</div><div class="line">        """</div><div class="line">        stack = getattr(self._local, <span class="string">'stack'</span>, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> stack <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">elif</span> len(stack) == <span class="number">1</span>:</div><div class="line">            release_local(self._local)</div><div class="line">            <span class="keyword">return</span> stack[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> stack.pop()</div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""The topmost item on the stack.  If the stack is empty,</span></div><div class="line">        `None` is returned.</div><div class="line">        """</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self._local.stack[<span class="number">-1</span>]</div><div class="line">        <span class="keyword">except</span> (AttributeError, IndexError):</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
<p>我们在之前看到了 <code>request context</code> 的定义，它就是一个 <code>LocalStack</code> 的实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_request_ctx_stack = LocalStack()</div></pre></td></tr></table></figure>
<p>它会当前线程或者协程的请求都保存在栈里，等使用的时候再从里面读取。至于为什么要用到栈结构，而不是直接使用 <code>Local</code>，我们会在后面揭晓答案，你可以先思考一下。</p>
<p><code>LocalProxy</code> 是一个 <code>Local</code> 对象的代理，负责把所有对自己的操作转发给内部的 <code>Local</code> 对象。<code>LocalProxy</code> 的构造函数介绍一个 <code>callable</code> 的参数，这个 <code>callable</code> 调用之后需要返回一个 <code>Local</code> 实例，后续所有的属性操作都会转发给 <code>callable</code> 返回的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalProxy</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Acts as a proxy for a werkzeug local.</span></div><div class="line">    Forwards all operations to a proxied object. """</div><div class="line">    __slots__ = (<span class="string">'__local'</span>, <span class="string">'__dict__'</span>, <span class="string">'__name__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, local, name=None)</span>:</span></div><div class="line">        object.__setattr__(self, <span class="string">'_LocalProxy__local'</span>, local)</div><div class="line">        object.__setattr__(self, <span class="string">'__name__'</span>, name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_current_object</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Return the current object."""</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self.__local, <span class="string">'__release_local__'</span>):</div><div class="line">            <span class="keyword">return</span> self.__local()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> getattr(self.__local, self.__name__)</div><div class="line">        <span class="keyword">except</span> AttributeError:</div><div class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'no object bound to %s'</span> % self.__name__)</div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__dict__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> self._get_current_object().__dict__</div><div class="line">        <span class="keyword">except</span> RuntimeError:</div><div class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">'__dict__'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></div><div class="line">        <span class="keyword">if</span> name == <span class="string">'__members__'</span>:</div><div class="line">            <span class="keyword">return</span> dir(self._get_current_object())</div><div class="line">        <span class="keyword">return</span> getattr(self._get_current_object(), name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></div><div class="line">        self._get_current_object()[key] = value</div></pre></td></tr></table></figure>
<p>这里实现的关键是把通过参数传递进来的 <code>Local</code> 实例保存在 <code>__local</code> 属性中，并定义了 <code>_get_current_object()</code> 方法获取当前线程或者协程对应的对象。</p>
<p><em>NOTE：前面双下划线的属性，会保存到 <code>_ClassName__variable</code> 中。所以这里通过 <code>_LocalProxy__local</code> 设置的值，后面可以通过 <code>self.__local</code> 来获取。关于这个知识点，可以查看 <a href="http://stackoverflow.com/questions/1301346/the-meaning-of-a-single-and-a-double-underscore-before-an-object-name-in-python" target="_blank" rel="external">stackoverflow</a> 的这个问题。</em></p>
<p>然后 <code>LocalProxy</code> 重写了所有的魔术方法（名字前后有两个下划线的方法），具体操作都是转发给代理对象的。这里只给出了几个魔术方法，感兴趣的可以查看源码中所有的魔术方法。<br>继续回到 <code>request context</code> 的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">_request_ctx_stack = LocalStack()</div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div><div class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</div></pre></td></tr></table></figure>
<p>再次看这段代码希望能看明白，<code>_request_ctx_stack</code> 是多线程或者协程隔离的栈结构，<code>request</code> 每次都会调用 <code>_lookup_req_object</code> 栈头部的数据来获取保存在里面的 <code>requst context</code>。</p>
<p>那么请求上下文信息是什么被放在 stack 中呢？还记得之前介绍的 <code>wsgi_app()</code> 方法有下面两行代码吗？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ctx = self.request_context(environ)</div><div class="line">ctx.push()</div></pre></td></tr></table></figure>
<p>每次在调用 <code>app.__call__</code> 的时候，都会把对应的请求信息压栈，最后执行完请求的处理之后把它出栈。<br>我们来看看request_context， 这个 方法只有一行代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_context</span><span class="params">(self, environ)</span>:</span></div><div class="line">    <span class="keyword">return</span> RequestContext(self, environ)</div></pre></td></tr></table></figure>
<p>它调用了 <code>RequestContext</code>，并把 <code>self</code> 和请求信息的字典 <code>environ</code> 当做参数传递进去。追踪到 <code>RequestContext</code> 定义的地方，它出现在 <code>ctx.py</code> 文件中，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""The request context contains all request relevant information.  It is</span></div><div class="line">    created at the beginning of the request and pushed to the</div><div class="line">    `_request_ctx_stack` and removed at the end of it.  It will create the</div><div class="line">    URL adapter and request object for the WSGI environment provided.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app, environ, request=None)</span>:</span></div><div class="line">        self.app = app</div><div class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            request = app.request_class(environ)</div><div class="line">        self.request = request</div><div class="line">        self.url_adapter = app.create_url_adapter(self.request)</div><div class="line">        self.match_request()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">match_request</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Can be overridden by a subclass to hook into the matching</span></div><div class="line">        of the request.</div><div class="line">        """</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            url_rule, self.request.view_args = \</div><div class="line">                self.url_adapter.match(return_rule=<span class="keyword">True</span>)</div><div class="line">            self.request.url_rule = url_rule</div><div class="line">        <span class="keyword">except</span> HTTPException <span class="keyword">as</span> e:</div><div class="line">            self.request.routing_exception = e</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Binds the request context to the current context."""</span></div><div class="line">        <span class="comment"># Before we push the request context we have to ensure that there</span></div><div class="line">        <span class="comment"># is an application context.</span></div><div class="line">        app_ctx = _app_ctx_stack.top</div><div class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</div><div class="line">            app_ctx = self.app.app_context()</div><div class="line">            app_ctx.push()</div><div class="line">            self._implicit_app_ctx_stack.append(app_ctx)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._implicit_app_ctx_stack.append(<span class="keyword">None</span>)</div><div class="line"></div><div class="line">        _request_ctx_stack.push(self)</div><div class="line"></div><div class="line">        self.session = self.app.open_session(self.request)</div><div class="line">        <span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            self.session = self.app.make_null_session()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self, exc=_sentinel)</span>:</span></div><div class="line">        <span class="string">"""Pops the request context and unbinds it by doing that.  This will</span></div><div class="line">        also trigger the execution of functions registered by the</div><div class="line">        :meth:`~flask.Flask.teardown_request` decorator.</div><div class="line">        """</div><div class="line">        app_ctx = self._implicit_app_ctx_stack.pop()</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            clear_request = <span class="keyword">False</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._implicit_app_ctx_stack:</div><div class="line">                self.app.do_teardown_request(exc)</div><div class="line"></div><div class="line">                request_close = getattr(self.request, <span class="string">'close'</span>, <span class="keyword">None</span>)</div><div class="line">                <span class="keyword">if</span> request_close <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                    request_close()</div><div class="line">                clear_request = <span class="keyword">True</span></div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            rv = _request_ctx_stack.pop()</div><div class="line"></div><div class="line">            <span class="comment"># get rid of circular dependencies at the end of the request</span></div><div class="line">            <span class="comment"># so that we don't require the GC to be active.</span></div><div class="line">            <span class="keyword">if</span> clear_request:</div><div class="line">                rv.request.environ[<span class="string">'werkzeug.request'</span>] = <span class="keyword">None</span></div><div class="line"></div><div class="line">            <span class="comment"># Get rid of the app as well if necessary.</span></div><div class="line">            <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                app_ctx.pop(exc)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auto_pop</span><span class="params">(self, exc)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.request.environ.get(<span class="string">'flask._preserve_context'</span>) <span class="keyword">or</span> \</div><div class="line">           (exc <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> self.app.preserve_context_on_exception):</div><div class="line">            self.preserved = <span class="keyword">True</span></div><div class="line">            self._preserved_exc = exc</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.pop(exc)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        self.push()</div><div class="line">        <span class="keyword">return</span> self</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_value, tb)</span>:</span></div><div class="line">        self.auto_pop(exc_value)</div></pre></td></tr></table></figure>
<p>每个 <code>request context</code> 都保存了当前请求的信息，比如 <code>request</code> 对象和 <code>app</code> 对象。在初始化的最后，还调用了 <code>match_request</code> 实现了路由的匹配逻辑。</p>
<p><code>push</code> 操作就是把该请求的 <code>ApplicationContext</code>（如果 <code>_app_ctx_stack</code> 栈顶不是当前请求所在 <code>app</code> ，需要创建新的 <code>app context</code>） 和 <code>RequestContext</code> 有关的信息保存到对应的栈上，压栈后还会保存 <code>session</code> 的信息； <code>pop</code> 则相反，把 <code>request context</code> 和 <code>application context</code> 出栈，做一些清理性的工作。</p>
<p>到这里，上下文的实现就比较清晰了：每次有请求过来的时候，flask 会先创建当前线程或者进程需要处理的两个重要上下文对象，把它们保存到隔离的栈里面，这样视图函数进行处理的时候就能直接从栈上获取这些信息。</p>
<p><em>NOTE：因为 app 实例只有一个，因此多个 <code>request</code> 共享了 <code>application context</code>。</em></p>
<p>到这里，关于 context 的实现和功能已经讲解得差不多了。还有两个疑惑没有解答。</p>
<ol>
<li>为什么要把 <code>request context</code> 和 <code>application context</code> 分开？每个请求不是都同时拥有这两个上下文信息吗？</li>
<li>为什么 <code>request context</code> 和 <code>application context</code> 都有实现成栈的结构？每个请求难道会出现多个 <code>request context</code> 或者 <code>application context</code> 吗？</li>
</ol>
<p>第一个答案是“灵活度”，第二个答案是“多 application”。虽然在实际运行中，每个请求对应一个 <code>request context</code> 和一个 <code>application context</code>，但是在测试或者 python shell 中运行的时候，用户可以单独创建 <code>request context</code> 或者 <code>application context</code>，这种灵活度方便用户的不同的使用场景；而且栈可以让 redirect 更容易实现，一个处理函数可以从栈中获取重定向路径的多个请求信息。application 设计成栈也是类似，测试的时候可以添加多个上下文，另外一个原因是 flask 可以多个 application 同时运行:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> DispatcherMiddleware</div><div class="line"><span class="keyword">from</span> frontend_app <span class="keyword">import</span> application <span class="keyword">as</span> frontend</div><div class="line"><span class="keyword">from</span> backend_app <span class="keyword">import</span> application <span class="keyword">as</span> backend</div><div class="line"></div><div class="line">application = DispatcherMiddleware(frontend, &#123;</div><div class="line">    <span class="string">'/backend'</span>:     backend</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>这个例子就是使用 <code>werkzeug</code> 的 <code>DispatcherMiddleware</code> 实现多个 app 的分发，这种情况下 <code>_app_ctx_stack</code> 栈里会出现两个 <code>application context</code>。</p>
<h2 id="为什么要用-LocalProxy"><a href="#为什么要用-LocalProxy" class="headerlink" title="为什么要用 LocalProxy"></a>为什么要用 LocalProxy</h2><p>写完这篇文章之后，收到有位读者的疑问：为什么要使用 <code>LocalProxy</code>？不适用 <code>LocalProxy</code> 直接访问 <code>LocalStack</code> 的对象会有什么问题吗？</p>
<p>这是个很好的问题，上面也确实没有很明确地给出这个答案。这里解释一下！</p>
<p>首先明确一点，<code>Local</code> 和 <code>LocalStack</code> 实现了不同线程/协程之间的数据隔离。在为什么用 <code>LocalStack</code> 而不是直接使用 <code>Local</code> 的时候，我们说过这是因为 flask 希望在测试或者开发的时候，允许多 app 、多 request 的情况。而 <code>LocalProxy</code> 也是因为这个才引入进来的！</p>
<p>我们拿 <code>current_app = LocalProxy(_find_app)</code> 来举例子。每次使用 <code>current_app</code> 的时候，他都会调用 <code>_find_app</code> 函数，然后对得到的变量进行操作。</p>
<p>如果直接使用 <code>current_app = _find_app()</code> 有什么区别呢？区别就在于，我们导入进来之后，<code>current_app</code> 就不会再变化了。如果有多 app 的情况，就会出现错误，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</div><div class="line"></div><div class="line">app = create_app()</div><div class="line">admin_app = create_admin_app()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">with</span> app.app_context():</div><div class="line">        work_on(current_app)</div><div class="line">        <span class="keyword">with</span> admin_app.app_context():</div><div class="line">            work_on(current_app)</div></pre></td></tr></table></figure>
<p>这里我们出现了嵌套的 app，每个 with 上下文都需要操作其对应的 app，如果不适用 <code>LocalProxy</code> 是做不到的。</p>
<p>对于 <code>request</code> 也是类似！但是这种情况真的很少发生，有必要费这么大的功夫增加这么多复杂度吗？</p>
<p>其实还有一个更大的问题，这个例子也可以看出来。比如我们知道 <code>current_app</code> 是动态的，因为它背后对应的栈会 <code>push</code> 和 <code>pop</code> 元素进去。那刚开始的时候，栈一定是空的，只有在 <code>with app.app_context()</code> 这句的时候，才把栈数据 <code>push</code> 进去。而如果不采用 <code>LocalProxy</code> 进行转发，那么在最上面导入 <code>from flask import current_app</code> 的时候，<code>current_app</code> 就是空的，因为这个时候还没有把数据 <code>push</code> 进去，后面调用的时候根本无法使用。<br>所以为什么需要 <code>LocalProxy</code> 呢？简单总结一句话：因为上下文保存的数据是保存在栈里的，并且会动态发生变化。如果不是动态地去访问，会造成数据访问异常。</p>
<p><em>本文转自<a href="http://cizixs.com/2017/01/13/flask-insight-context" target="_blank" rel="external">Cizixs Writes Here</a></em></p>

        
        </div>
        <!--
        <footer class="article-footer">
            <div class="share-container">

    <div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_qzone">QQ空间</a>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<style>
    .jiathis_style div:first-child:not(.jiadiv_01) {
        width: auto !important;
        border: none !important;
    }
    .jiathis_style .jiadiv_01 {
        margin: 10px 0;
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .jiathis_style .jiadiv_01 div:first-child {
        display: none;
    }
    .jiathis_style .jiadiv_02 {
        padding: 7px 0 !important;
    }
    .jiathis_style .jiadiv_02 .jiatitle {
        width: 85px;
        border: none;
        height: auto;
        margin: 3px 10px;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .jiathis_style .jiadiv_02 .jiatitle:hover {
        border: none;
    }
    .jiathis_style .jiadiv_02 .jiatitle:nth-child(even) {
        margin-left: 0;
    }
    .jiathis_style .jtico:hover {
        opacity: 1;
    }
    .jiathis_style .ckepopBottom,
    .jiathis_style .centerBottom {
        width: auto !important;
        padding: 5px;
        background: #f7f7f7;
    }
</style>



</div>

            
    
        <a href="http://esoftmobile.com/2017/03/09/flask-context/#comments" class="article-comment-link">评论</a>
    

        </footer>
        -->
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2017/03/08/flask-routing/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">flask 源码解析：路由</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="uyan_frame"></div>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/09/flask-context/" class="thumbnail">
    
    
        <span style="background-image:url(/image/flask.png)" alt="flask 源码解析：上下文" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/03/09/flask-context/" class="title">flask 源码解析：上下文</a></p>
                            <p class="item-date"><time datetime="2017-03-09T08:50:31.000Z" itemprop="datePublished">2017-03-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/08/flask-routing/" class="thumbnail">
    
    
        <span style="background-image:url(/image/flask.png)" alt="flask 源码解析：路由" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/03/08/flask-routing/" class="title">flask 源码解析：路由</a></p>
                            <p class="item-date"><time datetime="2017-03-08T07:51:13.000Z" itemprop="datePublished">2017-03-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/07/flask-start-process/" class="thumbnail">
    
    
        <span style="background-image:url(/image/flask.png)" alt="flask 源码解析：应用启动流程" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/03/07/flask-start-process/" class="title">flask 源码解析：应用启动流程</a></p>
                            <p class="item-date"><time datetime="2017-03-07T09:23:44.000Z" itemprop="datePublished">2017-03-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/06/flask-into/" class="thumbnail">
    
    
        <span style="background-image:url(/image/flask.png)" alt="Flask源码解析：简介" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/03/06/flask-into/" class="title">Flask源码解析：简介</a></p>
                            <p class="item-date"><time datetime="2017-03-06T09:14:12.000Z" itemprop="datePublished">2017-03-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2015/03/23/ios-devices-mdm/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2015/03/23/ios-devices-mdm/" class="title">iOS设备MDM开发流程证书相关</a></p>
                            <p class="item-date"><time datetime="2015-03-23T10:08:34.000Z" itemprop="datePublished">2015-03-23</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">五月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">二月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">一月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">十月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Effective-Objective-C/" style="font-size: 12px;">Effective Objective-C</a> <a href="/tags/HTML5/" style="font-size: 12px;">HTML5</a> <a href="/tags/Hack/" style="font-size: 12px;">Hack</a> <a href="/tags/JavaScript/" style="font-size: 12px;">JavaScript</a> <a href="/tags/MDM/" style="font-size: 10px;">MDM</a> <a href="/tags/Mac/" style="font-size: 12px;">Mac</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/Notes/" style="font-size: 14px;">Notes</a> <a href="/tags/Objective-C/" style="font-size: 18px;">Objective-C</a> <a href="/tags/Other/" style="font-size: 10px;">Other</a> <a href="/tags/Raspberry-Pi/" style="font-size: 12px;">Raspberry Pi</a> <a href="/tags/Sinppets/" style="font-size: 10px;">Sinppets</a> <a href="/tags/Unix/" style="font-size: 10px;">Unix</a> <a href="/tags/Web/" style="font-size: 12px;">Web</a> <a href="/tags/Xcode/" style="font-size: 12px;">Xcode</a> <a href="/tags/clang/" style="font-size: 10px;">clang</a> <a href="/tags/flask/" style="font-size: 16px;">flask</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/llvm/" style="font-size: 10px;">llvm</a> <a href="/tags/python/" style="font-size: 16px;">python</a> <a href="/tags/runtime/" style="font-size: 12px;">runtime</a> <a href="/tags/只读经典/" style="font-size: 16px;">只读经典</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 TracyYih<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1784645"></script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>