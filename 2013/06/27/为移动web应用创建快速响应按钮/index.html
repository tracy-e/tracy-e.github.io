<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 为移动Web应用创建快速响应按钮 · Esoft Mobile</title><meta name="description" content="为移动Web应用创建快速响应按钮 - Tracy Yih"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://esoftmobile.com/atom.xml" title="Esoft Mobile"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/534072785" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/tracy-e" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">为移动Web应用创建快速响应按钮</h1><div class="post-info">Jun 27, 2013</div><div class="post-content"><blockquote>
<p>英文原文出自Google Deveploers<a href="https://developers.google.com/mobile/articles/fast_buttons" target="_blank" rel="external">《Creating Fast Buttons for Mobile Web Applications》</a>，由<a href="http://weibo.com/534072785" target="_blank" rel="external">TracyYih</a>翻译，并首发于EsoftMobile.com。如需转载，请注明译者及出处信息。</p>
</blockquote>
<p>##背景<br>在Google，我们不断地突破移动Web应用能够达到的效果，HTML5这类技术让原生应用和Web应用的界线开始变得模糊。为了这个目标，我们开发了一种新技术让纯HTML按钮能够有更快的响应。这之前，我们可能只是为按钮或者其他可以点击的元素增加点击处理，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">'signUp()'</span>&gt;</span>Sign Up!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用这种方法存在一个问题就是，移动浏览器会在你点击按钮后300ms才触发事件，原因是浏览器需要区分你是否是要执行双击。但是对于大多数按钮，我们并不需要它处理双击事件，所以300ms的延时时间对于只是想执行点击事件的用户来说太长了。我们最早开发这种技术是在<a href="http://googlevoiceblog.blogspot.com/2010/01/google-voice-for-iphone-and-palm-webos.html" target="_blank" rel="external">Google Voice mobile web app</a>中，我们希望能够更加迅速的调用拨号事件。</p>
<p>##处理触摸事件<br>该技术涉及一点JavaScript的东西来让按钮响应触摸（Touch）事件而不是点击（Click）事件。触摸事件响应不会有延时所以感受会比点击事件快很多，但是我们也需要考虑以下几个问题：</p>
<ol>
<li>如果用户是点击屏幕上其他的元素而触发了按钮的触摸事件，这种情况我们不应该去执行按钮的事件。</li>
<li>如果用户按下按钮然后拖到屏幕其他位置而触发了触摸事件，我们也不应该执行按钮的事件。</li>
<li>我们希望按钮在按下的时间能够高亮来表示点击状态。</li>
</ol>
<a id="more"></a>
<p>我们能够通过检测touchstart和touchmove事件来解决前两个问题，只需要考虑一个一开始在按钮上就是touchstart状态的触摸事件，而如果touchstart后存在了一个touchmove，那我们就不应该处理touchend事件。</p>
<p>我们可以通过同时给按钮添加onclick处理来解决第三个问题，这样浏览器就会把它当成按钮并在点击时出现高亮。我们touchend处理也能保证按钮仍然很快响应，同时添加onclick可以在不支持触摸事件的浏览器上做为比较可靠的备用方案。</p>
<p>##破坏讨厌的点击</p>
<p>在添加触摸事件的同时添加onclick事件又会带来另一个讨厌的问题，当你点击按钮时，点击(click)事件仍然会在300ms后执行，我们可以通过在touchstart事件里调用preventDefault来解决。在touchstart中调用preventDefault方法会会导致点击和滑动失效，但我们又想用户能够滑动视图即使一开始是点在按钮上，所以我们仍不能接受这种解决方案。接来下我们想出了一个被我们叫做点击破坏者（Click buster）的方案，我们给body添加一个点击事件监听（listener），当监听事件被触发，我们会区分点击是否由我们已经处理的tap事件导致的，如果这样，我们才调用preventDefault和stopPropagation。</p>
<p>###Fast Button Code</p>
<p>下面我们会提供一些我们实现这个想法的代码。</p>
<p>通过标签和事件创建一个FastButton</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">google.ui.FastButton = <span class="function"><span class="keyword">function</span>(<span class="params">element, handler</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.element = element;</div><div class="line">	<span class="keyword">this</span>.handler = handler;</div><div class="line">	</div><div class="line">	element.addEventListener(<span class="string">'touchstart'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">	element.addEventListener(<span class="string">'click'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">google.ui.FastButton.prototype.handleEvent = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	<span class="keyword">switch</span>(event.type) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchstart'</span>: <span class="keyword">this</span>.onTouchStart(event); <span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchmove'</span>: <span class="keyword">this</span>.onTouchMove(event); <span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchend'</span>: <span class="keyword">this</span>.onClick(event); <span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'click'</span>: <span class="keyword">this</span>.onClick(event); <span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>保存touchstart坐标，并开始监听touchmove和touchend事件，调用stopPropagation来保证其他操作不会触发点击事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">google.ui.FastButton.prototype.onTouchStart = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	event.stopPropagation();</div><div class="line">	</div><div class="line">	<span class="keyword">this</span>.element.addEventListener(<span class="string">'touchend'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">	<span class="built_in">document</span>.body.element.addEventListener(<span class="string">'touchmove'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">this</span>.startX = event.touches[<span class="number">0</span>].clientX;</div><div class="line">	<span class="keyword">this</span>.startY = event.touches[<span class="number">0</span>].clientY;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>当touchmove事件触发时，检查用户是否拖动超过10px。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">google.ui.FastButton.prototype.onTouchMove = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">Math</span>.abs(event.touches[<span class="number">0</span>].clientX - <span class="keyword">this</span>.startX) &gt; <span class="number">10</span> ||</div><div class="line">		<span class="built_in">Math</span>.abs(event.touches[<span class="number">0</span>].clientY - <span class="keyword">this</span>.startY) &gt; <span class="number">10</span>) &#123;</div><div class="line">		<span class="keyword">this</span>.reset();	</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>执行真正的点击事件并在touchend事件时避免讨厌的click。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">google.ui.FastButton.prototype.onClick = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	event.stopPropagation();</div><div class="line">	<span class="keyword">this</span>.reset();</div><div class="line">	<span class="keyword">this</span>.handler(event);</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (event.type == <span class="string">'touchend'</span>) &#123;</div><div class="line">		google.clickbuster.preventGhostClick(<span class="keyword">this</span>.startX, <span class="keyword">this</span>.startY);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">google.ui.FastButton.prototype.reset = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.element.removeEventListener(<span class="string">'touchend'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">	<span class="built_in">document</span>.body.removeEventListener(<span class="string">'touchmove'</span>, <span class="keyword">this</span>, <span class="literal">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用preventGhostClick来破坏在接下来2.5s内x,移动距离在25px内的点击事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">google.clickbuster.preventGhostClick = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</div><div class="line">	google.clickbuster.coordinates.push(x ,y);</div><div class="line">	<span class="built_in">window</span>.setTimeout(google.clickbuster.pop, <span class="number">2500</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">google.clickbuster.pop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	google.clickbuster.coordinates.splice(<span class="number">0</span>, <span class="number">2</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如果我们在给定的半径和时间内捕获到了点击事件，调用stopPropagation和preventDefault。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">google.clickbuster.onClick = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; google.clickbuster.coordinates.length; i += <span class="number">2</span>) &#123;</div><div class="line">		<span class="keyword">var</span> x = google.clickbuster.coordinates[i];</div><div class="line">		<span class="keyword">var</span> y = google.clickbuster.coordinates[i + <span class="number">1</span>];</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">Math</span>.abs(event.clientX - x) &lt; <span class="number">25</span> &amp;&amp; <span class="built_in">Math</span>.abs(event.clientY - y) &lt; <span class="number">25</span>) &#123;</div><div class="line">		event.stopPropagation();</div><div class="line">		event.preventDefault();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, google.clickbuster.onClick, <span class="literal">true</span>);</div><div class="line">google.clickbuster.coordinates = [];</div></pre></td></tr></table></figure>
<p>##总结<br>到这里你应该能够创建快速响应的按钮了，花一点心思，你可以让它们看起来更像你所面向平台的原生按钮。现在已经有一些JavaScript库也提供了这种问题的解决方案，但是到目前为止我们没有发现有提供可靠备选方案和讨厌的点击问题。我们希望浏览器开发者能够在能够解决在不能缩放的页面上快速响应的问题，事实上我们已经在Gingerbread的浏览器上实现了。</p>
<p>测试代码<a href="https://github.com/tracy-e/FastButtonDemo" target="_blank" rel="external">FastButtonDemo</a>已上传github。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2013/07/13/黑客与画家/" class="prev">上一篇</a><a href="/2013/06/23/ios7程序后台运行/" class="next">下一篇</a></div><div class="copyright"><p>© 2012 - 2017 <a href="http://esoftmobile.com">Tracy Yih</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>